<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Panel Administrativo - BlackQuery</title>
    <link rel="stylesheet" href="css/styles.css" />
    <link rel="stylesheet" href="css/dark-mode-base.css" />
    <link rel="stylesheet" href="css/dark-mode-principal.css" />
    <link rel="stylesheet" href="css/dark-mode-admin.css" />
    <style>
      /* Estilos globales del body */
      body {
        background: var(--bg-color, #f4f6f9);
        color: var(--text-color, #333);
        transition: all 0.3s ease;
        margin: 0;
        padding: 0;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      [data-theme="dark"] body {
        background: #1a1a2e !important;
        color: #ecf0f1 !important;
      }

      h1,
      h2,
      h3,
      h4,
      h5 {
        color: var(--text-color, #333);
      }

      [data-theme="dark"] h1,
      [data-theme="dark"] h2,
      [data-theme="dark"] h3,
      [data-theme="dark"] h4,
      [data-theme="dark"] h5 {
        color: #ecf0f1 !important;
      }

      .admin-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
        min-height: 100vh;
      }

      .admin-section {
        background: var(--card-bg, white);
        border-radius: 10px;
        padding: 25px;
        margin: 20px 0;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
      }

      /* Soporte Dark Mode */
      [data-theme="dark"] .admin-section {
        background: #2c3e50 !important;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3) !important;
      }

      .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin: 20px 0;
      }

      .dashboard-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        transition: transform 0.3s ease;
      }

      .dashboard-card:hover {
        transform: translateY(-5px);
      }

      .dashboard-card h3 {
        margin: 0 0 10px 0;
        font-size: 1.2em;
      }

      .dashboard-card .number {
        font-size: 2.5em;
        font-weight: bold;
        margin: 10px 0;
      }

      .tabs {
        display: flex;
        background: var(--tab-bg, #f8f9fa);
        border-radius: 8px;
        margin: 20px 0;
        overflow: hidden;
        flex-wrap: wrap;
      }

      [data-theme="dark"] .tabs {
        background: #34495e !important;
      }

      .tab {
        flex: 1;
        min-width: 150px;
        padding: 15px 20px;
        background: var(--tab-inactive, #e9ecef);
        border: none;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: bold;
        color: var(--text-color, #333);
      }

      [data-theme="dark"] .tab {
        background: #2c3e50 !important;
        color: #ecf0f1 !important;
      }

      .tab.active {
        background: #007bff;
        color: white;
      }

      [data-theme="dark"] .tab.active {
        background: #3498db !important;
        color: white !important;
      }

      .tab:hover:not(.active) {
        background: #dee2e6;
      }

      [data-theme="dark"] .tab:hover:not(.active) {
        background: #34495e !important;
      }

      .tab-content {
        display: none;
        animation: fadeIn 0.3s;
      }

      .tab-content.active {
        display: block;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .data-table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px 0;
        overflow-x: auto;
        display: block;
      }

      .data-table thead,
      .data-table tbody {
        display: table;
        width: 100%;
        table-layout: fixed;
      }

      .data-table th,
      .data-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid var(--border-color, #ddd);
        color: var(--text-color, #333);
      }

      [data-theme="dark"] .data-table th,
      [data-theme="dark"] .data-table td {
        border-bottom-color: #34495e !important;
        color: #ecf0f1 !important;
      }

      .data-table th {
        background: var(--table-header-bg, #f8f9fa);
        font-weight: bold;
      }

      [data-theme="dark"] .data-table th {
        background: #34495e !important;
      }

      .data-table tr:hover {
        background: var(--table-hover, #f5f5f5);
      }

      [data-theme="dark"] .data-table tr:hover {
        background: #34495e !important;
      }

      .btn-admin {
        background: #28a745;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        margin: 2px;
        font-size: 12px;
        transition: all 0.3s;
      }

      .btn-admin:hover {
        background: #218838;
        transform: translateY(-2px);
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      }

      .btn-admin.danger {
        background: #dc3545;
      }

      .btn-admin.danger:hover {
        background: #c82333;
      }

      .btn-admin.warning {
        background: #ffc107;
        color: #212529;
      }

      .btn-admin.warning:hover {
        background: #e0a800;
      }

      .status-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: bold;
        text-transform: uppercase;
      }

      .status-active {
        background: #d4edda;
        color: #155724;
      }
      .status-pending {
        background: #fff3cd;
        color: #856404;
      }
      .status-expired {
        background: #f8d7da;
        color: #721c24;
      }
      .status-processing {
        background: #d1ecf1;
        color: #0c5460;
      }

      .alert-list {
        max-height: 400px;
        overflow-y: auto;
      }

      .alert-item {
        background: var(--alert-bg, #fff3cd);
        border: 1px solid var(--alert-border, #ffeaa7);
        border-radius: 6px;
        padding: 12px;
        margin: 8px 0;
        border-left: 4px solid #f39c12;
        color: var(--text-color, #333);
      }

      [data-theme="dark"] .alert-item {
        background: #34495e !important;
        border-color: #2c3e50 !important;
        color: #ecf0f1 !important;
      }

      .alert-item.critical {
        background: var(--alert-critical-bg, #f8d7da);
        border-color: var(--alert-critical-border, #f5c6cb);
        border-left-color: #dc3545;
      }

      [data-theme="dark"] .alert-item.critical {
        background: #5d4e60 !important;
        border-color: #4a3f50 !important;
      }

      .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
        margin: 15px 0;
      }

      .form-group {
        margin: 10px 0;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: var(--text-color, #333);
      }

      [data-theme="dark"] .form-group label {
        color: #ecf0f1 !important;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 8px;
        border: 1px solid var(--border-color, #ddd);
        border-radius: 4px;
        font-size: 14px;
        background: var(--input-bg, white);
        color: var(--text-color, #333);
      }

      [data-theme="dark"] .form-group input,
      [data-theme="dark"] .form-group select,
      [data-theme="dark"] .form-group textarea {
        background: #34495e !important;
        border-color: #2c3e50 !important;
        color: #ecf0f1 !important;
      }

      /* Modal Styles with Dark Mode Support */
      .modal-overlay {
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(4px);
      }

      .modal-content,
      div[id$="-modal"] > div {
        background: var(--card-bg, white) !important;
        color: var(--text-color, #2c3e50) !important;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        transition: all 0.3s ease;
      }

      [data-theme="dark"] .modal-content,
      [data-theme="dark"] div[id$="-modal"] > div {
        background: #2c3e50 !important;
        color: #ecf0f1 !important;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.7) !important;
      }

      [data-theme="dark"] div[id$="-modal"] h4 {
        color: #ecf0f1 !important;
      }

      [data-theme="dark"] .form-group input:focus,
      [data-theme="dark"] .form-group select:focus,
      [data-theme="dark"] .form-group textarea:focus {
        border-color: #667eea !important;
        outline: none !important;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15) !important;
      }

      [data-theme="dark"] .form-group input[readonly] {
        background: #1a202c !important;
        color: #a0aec0 !important;
        cursor: not-allowed;
      }

      .alert {
        padding: 12px;
        border-radius: 6px;
        margin: 10px 0;
        font-weight: 500;
      }

      .alert-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      [data-theme="dark"] .alert-success {
        background: #1e4620 !important;
        color: #9ae6b4 !important;
        border: 1px solid #2f855a !important;
      }

      .alert-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      [data-theme="dark"] .alert-error {
        background: #5a1a1a !important;
        color: #fc8181 !important;
        border: 1px solid #9b2c2c !important;
      }

      .alert-info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }

      [data-theme="dark"] .alert-info {
        background: #1a3a52 !important;
        color: #63b3ed !important;
        border: 1px solid #2c5282 !important;
      }

      /* Danger Box para advertencias crÃ­ticas */
      .danger-box {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        border-radius: 8px;
        padding: 15px;
        margin: 15px 0;
        border-left: 4px solid #dc3545;
        color: #721c24;
      }

      [data-theme="dark"] .danger-box {
        background: #5a1a1a !important;
        border-color: #9b2c2c !important;
        color: #fc8181 !important;
      }

      .danger-box strong {
        display: block;
        margin-bottom: 10px;
        font-size: 1.1em;
      }

      .danger-box ul {
        margin: 10px 0;
        padding-left: 20px;
      }

      /* Modal overlay mejorado */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        backdrop-filter: blur(4px);
      }

      .modal-overlay .modal-content {
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
      }

      .compliance-summary {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        margin: 20px 0;
      }

      .compliance-items {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin: 15px 0;
      }

      .compliance-item {
        text-align: center;
      }

      .compliance-item .icon {
        font-size: 2em;
        margin-bottom: 10px;
      }
    </style>
  </head>
  <body>
    <nav class="navbar">
      <span class="navbar-title">BlackQuery Admin</span>
      <div class="navbar-actions">
        <button onclick="logout()" class="btn logout">Cerrar SesiÃ³n</button>
      </div>
    </nav>

    <div class="admin-container" id="admin-container">
      <!-- PestaÃ±as de administraciÃ³n -->
      <div class="admin-section">
        <div class="tabs">
          <button class="tab active" onclick="showTab('user-management')">
            ğŸ‘¥ GestiÃ³n de Usuarios
          </button>
          <button class="tab" onclick="showTab('privacy-requests')">
            ğŸ”’ Solicitudes de Privacidad
          </button>
          <button class="tab" onclick="showTab('data-treatment')">
            ğŸ“‹ Tratamiento de Datos
          </button>
          <button class="tab" onclick="showTab('dpa-management')">
            â˜ï¸ GestiÃ³n DPA
          </button>
          <button class="tab" onclick="showTab('system-health')">
            ğŸ’š Estado del Sistema
          </button>
        </div>

        <!-- Contenido de GestiÃ³n de Usuarios -->
        <div id="user-management" class="tab-content active">
          <h3>ğŸ‘¥ GestiÃ³n de Usuarios</h3>

          <div class="dashboard-grid">
            <div class="dashboard-card">
              <h3>ğŸ‘¨â€ğŸ“ Estudiantes</h3>
              <div class="number" id="students-count">-</div>
              <p>Usuarios estudiantes</p>
            </div>
            <div class="dashboard-card">
              <h3>ğŸ‘¨â€ğŸ« Docentes</h3>
              <div class="number" id="teachers-count">-</div>
              <p>Usuarios docentes</p>
            </div>
            <div class="dashboard-card">
              <h3>âš™ï¸ Administradores</h3>
              <div class="number" id="admins-count">-</div>
              <p>Usuarios admin</p>
            </div>
            <div class="dashboard-card">
              <h3>ğŸ“Š Total Usuarios</h3>
              <div class="number" id="total-users-count">-</div>
              <p>Usuarios registrados</p>
            </div>
          </div>

          <div class="admin-section">
            <div id="role-specific-actions">
              <!-- Se carga dinÃ¡micamente segÃºn el rol del usuario -->
            </div>
          </div>

          <div class="admin-section">
            <h4>ğŸ“‹ Lista de Usuarios</h4>
            <div id="users-table-container">
              <!-- Se carga dinÃ¡micamente -->
            </div>
          </div>

          <!-- Modal para crear usuario -->
          <div
            id="create-user-modal"
            style="
              display: none;
              position: fixed;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              background: rgba(0, 0, 0, 0.5);
              z-index: 1000;
              justify-content: center;
              align-items: center;
            "
          >
            <div
              style="
                background: white;
                padding: 30px;
                border-radius: 10px;
                max-width: 500px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
              "
            >
              <h4 id="modal-title">â• Crear Nuevo Usuario</h4>
              <form id="create-user-form" onsubmit="createUser(event)">
                <div class="form-group">
                  <label>ğŸ“§ Email:</label>
                  <input type="email" name="email" required />
                </div>
                <div class="form-group">
                  <label>ğŸ‘¤ Nombre de Usuario:</label>
                  <input type="text" name="username" required />
                </div>
                <div class="form-group">
                  <label>ğŸ”‘ ContraseÃ±a:</label>
                  <input
                    type="password"
                    name="password"
                    required
                    minlength="6"
                  />
                </div>
                <div class="form-group">
                  <label>ğŸ”‘ Confirmar ContraseÃ±a:</label>
                  <input
                    type="password"
                    name="confirm_password"
                    required
                    minlength="6"
                  />
                </div>
                <div class="form-group">
                  <label>ğŸ‘¥ Rol:</label>
                  <select name="role" id="role-select" required>
                    <!-- Se carga dinÃ¡micamente segÃºn el rol del usuario actual -->
                  </select>
                </div>
                <div class="form-group">
                  <label>ğŸ‘¨â€ğŸ’¼ Nombre Completo:</label>
                  <input type="text" name="full_name" required />
                </div>
                <div style="display: flex; gap: 10px; margin-top: 20px">
                  <button type="submit" class="btn-admin">
                    âœ… Crear Usuario
                  </button>
                  <button
                    type="button"
                    class="btn-admin danger"
                    onclick="hideCreateUserModal()"
                  >
                    âŒ Cancelar
                  </button>
                </div>
              </form>
            </div>
          </div>

          <!-- Modal para cambiar rol eliminado -->
        </div>

        <!-- Contenido de Solicitudes de Privacidad -->
        <div id="privacy-requests" class="tab-content">
          <h3>ğŸ”’ Solicitudes de Privacidad Pendientes</h3>
          <div id="privacy-requests-list">
            <!-- Se carga dinÃ¡micamente -->
          </div>
        </div>

        <!-- Contenido de Tratamiento de Datos -->
        <div id="data-treatment" class="tab-content">
          <h3>ğŸ“‹ Registro de Tratamiento de Datos (PRF4)</h3>

          <div class="compliance-summary">
            <h4>ğŸ“Š Estado de Cumplimiento GDPR</h4>
            <div id="gdpr-compliance">
              <!-- Se carga dinÃ¡micamente -->
            </div>
          </div>

          <button class="btn-admin" onclick="showCreateTreatmentForm()">
            â• Nuevo Tratamiento
          </button>

          <div
            id="create-treatment-form"
            style="
              display: none;
              background: #f8f9fa;
              padding: 20px;
              border-radius: 8px;
              margin: 15px 0;
            "
          >
            <h4>Crear Nuevo Registro de Tratamiento</h4>
            <form onsubmit="createTreatment(event)">
              <div class="form-grid">
                <div class="form-group">
                  <label>Nombre del Tratamiento:</label>
                  <input type="text" name="treatment_name" required />
                </div>
                <div class="form-group">
                  <label>Base Legal:</label>
                  <select name="legal_basis" id="legal-basis-select" required>
                    <!-- Se carga dinÃ¡micamente -->
                  </select>
                </div>
                <div class="form-group">
                  <label>PerÃ­odo de RetenciÃ³n:</label>
                  <select
                    name="retention_period"
                    id="retention-period-select"
                    required
                  >
                    <!-- Se carga dinÃ¡micamente -->
                  </select>
                </div>
              </div>
              <div class="form-group">
                <label>DescripciÃ³n:</label>
                <textarea name="treatment_description" required></textarea>
              </div>
              <div class="form-group">
                <label>CategorÃ­as de Datos (separadas por comas):</label>
                <input
                  type="text"
                  name="data_categories"
                  placeholder="personales,contacto,analÃ­ticos"
                  required
                />
              </div>
              <div class="form-group">
                <label>Campos de Datos:</label>
                <textarea
                  name="data_fields"
                  placeholder="email, nombre, IP, cookies..."
                  required
                ></textarea>
              </div>
              <div class="form-group">
                <label>PropÃ³sito del Procesamiento:</label>
                <textarea name="processing_purpose" required></textarea>
              </div>
              <div class="form-group">
                <label>Actividades de Procesamiento:</label>
                <textarea name="processing_activities" required></textarea>
              </div>
              <div class="form-group">
                <label>Medidas de Seguridad:</label>
                <textarea
                  name="security_measures"
                  placeholder="Cifrado, control de acceso, logs de auditorÃ­a..."
                  required
                ></textarea>
              </div>
              <button type="submit" class="btn-admin">Crear Tratamiento</button>
              <button
                type="button"
                class="btn-admin danger"
                onclick="hideCreateTreatmentForm()"
              >
                Cancelar
              </button>
            </form>
          </div>

          <div id="treatments-list">
            <!-- Se carga dinÃ¡micamente -->
          </div>
        </div>

        <!-- Contenido de GestiÃ³n DPA -->
        <div id="dpa-management" class="tab-content">
          <h3>â˜ï¸ GestiÃ³n de Data Processing Agreements (PRF5)</h3>

          <div id="dpa-dashboard">
            <!-- Se carga dinÃ¡micamente -->
          </div>

          <div id="dpa-alerts" class="alert-list">
            <!-- Se carga dinÃ¡micamente -->
          </div>

          <button class="btn-admin" onclick="showCreateDpaForm()">
            â• Nuevo DPA
          </button>

          <div
            id="create-dpa-form"
            style="
              display: none;
              background: #f8f9fa;
              padding: 20px;
              border-radius: 8px;
              margin: 15px 0;
            "
          >
            <h4>Crear Nuevo DPA</h4>
            <form onsubmit="createDpa(event)">
              <div class="form-grid">
                <div class="form-group">
                  <label>Nombre del Proveedor:</label>
                  <input type="text" name="provider_name" required />
                </div>
                <div class="form-group">
                  <label>Proveedor Cloud:</label>
                  <select
                    name="cloud_provider"
                    id="cloud-provider-select"
                    required
                  >
                    <!-- Se carga dinÃ¡micamente -->
                  </select>
                </div>
                <div class="form-group">
                  <label>UbicaciÃ³n de Datos:</label>
                  <select
                    name="data_location"
                    id="data-location-select"
                    required
                  >
                    <!-- Se carga dinÃ¡micamente -->
                  </select>
                </div>
                <div class="form-group">
                  <label>Fecha de Firma:</label>
                  <input type="date" name="signed_date" required />
                </div>
                <div class="form-group">
                  <label>Fecha Efectiva:</label>
                  <input type="date" name="effective_date" required />
                </div>
                <div class="form-group">
                  <label>Fecha de ExpiraciÃ³n:</label>
                  <input type="date" name="expiry_date" required />
                </div>
              </div>
              <div class="form-group">
                <label>TÃ­tulo del DPA:</label>
                <input type="text" name="dpa_title" required />
              </div>
              <div class="form-group">
                <label>DescripciÃ³n:</label>
                <textarea name="dpa_description" required></textarea>
              </div>
              <div class="form-group">
                <label
                  >CategorÃ­as de Datos Procesados (separadas por comas):</label
                >
                <input type="text" name="data_categories_processed" required />
              </div>
              <div class="form-group">
                <label>PropÃ³sitos del Procesamiento:</label>
                <textarea name="processing_purposes" required></textarea>
              </div>
              <div class="form-group">
                <label>Medidas de Seguridad:</label>
                <textarea name="security_measures" required></textarea>
              </div>
              <button type="submit" class="btn-admin">Crear DPA</button>
              <button
                type="button"
                class="btn-admin danger"
                onclick="hideCreateDpaForm()"
              >
                Cancelar
              </button>
            </form>
          </div>

          <div id="dpas-list">
            <!-- Se carga dinÃ¡micamente -->
          </div>
        </div>

        <!-- Contenido de Estado del Sistema -->
        <div id="system-health" class="tab-content">
          <h3>ğŸ’š Estado del Sistema</h3>
          <div id="system-health-info">
            <!-- Se carga dinÃ¡micamente -->
          </div>
        </div>
      </div>
    </div>

    <script src="js/api-service.js"></script>
    <script src="js/autenticacion.js"></script>
    <script src="js/admin.js"></script>
    <script src="js/dark-mode.js"></script>
  </body>
</html>
